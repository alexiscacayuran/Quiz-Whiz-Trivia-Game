<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap"
      rel="stylesheet"
    />
    <link href="https://fonts.cdnfonts.com/css/peace-sans" rel="stylesheet" />
    <link rel="stylesheet" href="styles/main.css" />
    <title>Quiz Whiz: Trivia Game</title>
  </head>
  <body>
    <% const letterArray = ["A", "B", "C", "D"] %>
    <div class="container">
      <% for (const trivia of content) { %>
      <div class="trivia">
        <p id="category"><%= trivia.category %></p>
        <h2><%= trivia.question %></h2>
        <% trivia.choices.forEach((element, index) => { %>
        <button class="choices" id="<%= element %>">
          <span class="letters"><%= letterArray[index] %> </span>
          <p class="answer" style="display: inline"><%= element %></p>
        </button>
        <% }); %>
        <p style="display: none" id="<%= trivia.correct_answer %>"></p>
      </div>
      <% } %>

      <div class="result" style="display: none">
        <h2 class="result-message">Great!</h2>
        <p>Your score:</p>
        <p class="result-score"></p>
        <div class="result-button">
          <form method="post">
            <input type="hidden" name="amount" value="10" />
            <input type="hidden" name="difficulty" value="easy" />
            <input type="hidden" name="type" value="multiple" />
            <button type="submit" id="quickPlay" formaction="\play">
              TRY AGAIN
            </button>
          </form>

          <button id="play" onclick="window.location.href='/'">
            BACK TO MENU
          </button>
        </div>
      </div>
    </div>
  </body>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://code.jquery.com/jquery-3.7.1.js"
    integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
    crossorigin="anonymous"
  ></script>
  <script src="https://cdn.jsdelivr.net/npm/ejs@3.1.10/ejs.min.js"></script>

  <script>
    const amount = $(".trivia").length;
    const delay = 800;
    var points = 0;

    $(".trivia").hide();
    $(".trivia").first().show();

    const openQuestion = `.trivia[style]:not([style="display: none;"])`;
    const answerKey = `p[style="display: none"]`;

    $(".choices").one("click", (event) => {
      const answer = $(event.target).closest(".choices").attr("id");
      var correct_answer = $(openQuestion + " > " + answerKey).attr("id");

      // console.log(event.target);
      // console.log(answer);
      // console.log(correct_answer);

      if (answer === correct_answer) {
        points++;
        $(event.target).closest(".choices").addClass("correct");
        setTimeout(() => {
          $(event.target).closest(".choices").removeClass("correct");
        }, delay);
      } else {
        $(event.target).closest(".choices").addClass("wrong");
        $(openQuestion + ` > button:contains(` + correct_answer + `)`).addClass(
          "correct"
        );
        setTimeout(() => {
          $(event.target).closest(".choices").removeClass("wrong");
          $(
            openQuestion + ` > button:contains(` + correct_answer + `)`
          ).removeClass("correct");
        }, delay);
      }

      if ($(openQuestion).next(".trivia").length) {
        $(openQuestion).delay(delay).hide(0).next().delay(delay).fadeIn(200);
      } else {
        const score = (points / amount) * 100;

        $(openQuestion).delay(delay).hide(0);

        setTimeout(() => {
          $(".result-score").text(`${score}`);
          $(".result").fadeIn(200);
        }, delay);
      }
    });
  </script>
</html>
